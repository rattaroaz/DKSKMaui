<!DOCTYPE html>
<html>
<head>
    <title>Test PDF Generation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
</head>
<body>
    <h1>Test PDF Generation</h1>
    
    <div id="pdf-content-0" style="display: block; padding: 20px; border: 1px solid #ccc;">
        <h2>Sample Aging Report</h2>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th style="border: 1px solid #ddd; padding: 8px;">Invoice #</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Company</th>
                    <th style="border: 1px solid #ddd; padding: 8px;">Amount</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">10001</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">Test Company</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">$1,234.56</td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <br>
    <button onclick="testPDF()">Test PDF Generation</button>
    <button onclick="testFallback()">Test Fallback PDF</button>
    
    <script>
        // Copy the functions from index.html
        window.setPdfData = (data) => {
            console.log('Setting PDF data:', data);
            window.pdfData = data;
        };

        window.saveAsPDFByTemplate = (templateID, filename, isLandscape = false) => {
            console.log('saveAsPDFByTemplate called with:', templateID, filename, isLandscape);
            console.log('Current window.pdfData:', window.pdfData);
            
            try {
                const templateElement = document.getElementById(templateID);
                if (!templateElement) {
                    console.error('Template element not found:', templateID);
                    window.saveAsPDFFallback(templateID, filename, isLandscape);
                    return;
                }

                const orientation = isLandscape ? 'landscape' : 'portrait';
                
                // Get the HTML content
                const templateHtml = templateElement.innerHTML;
                console.log('Template HTML content length:', templateHtml ? templateHtml.length : 0);
                if (!templateHtml || templateHtml.trim() === '') {
                    console.error('Template content is empty');
                    window.saveAsPDFFallback(templateID, filename, isLandscape);
                    return;
                }

                // Create a temporary container
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = templateHtml;
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '-9999px';
                tempContainer.style.width = isLandscape ? '297mm' : '210mm';
                tempContainer.style.backgroundColor = 'white';
                document.body.appendChild(tempContainer);

                // Configure html2pdf options
                const options = {
                    margin: [10, 10, 10, 10],
                    filename: filename + '.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff'
                    },
                    jsPDF: {
                        unit: 'mm',
                        format: isLandscape ? [297, 210] : [210, 297],
                        orientation: orientation
                    }
                };

                // Generate PDF
                html2pdf()
                    .set(options)
                    .from(tempContainer)
                    .toPdf()
                    .get('pdf')
                    .then(function(pdf) {
                        pdf.save(filename + '.pdf');
                        document.body.removeChild(tempContainer);
                    })
                    .catch(function(error) {
                        console.error('PDF generation failed, trying fallback:', error);
                        document.body.removeChild(tempContainer);
                        window.saveAsPDFFallback(templateID, filename, isLandscape);
                    });

            } catch (error) {
                console.error('Error in saveAsPDFByTemplate:', error);
                window.saveAsPDFFallback(templateID, filename, isLandscape);
            }
        };

        window.saveAsPDFFallback = (templateID, filename, isLandscape = false) => {
            console.log('saveAsPDFFallback called');
            console.log('Available window.pdfData:', window.pdfData);
            
            try {
                if (!window.pdfData || !Array.isArray(window.pdfData) || window.pdfData.length === 0) {
                    console.error('No PDF data available for fallback generation');
                    alert('No data available for PDF generation. Please ensure there is data to export.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const orientation = isLandscape ? 'landscape' : 'portrait';
                const doc = new jsPDF({
                    orientation: orientation,
                    unit: 'mm',
                    format: 'a4'
                });

                // Create table from data
                const data = window.pdfData;
                const columns = Object.keys(data[0] || {});
                const rows = data.map(obj => Object.values(obj));

                // Add title
                doc.setFontSize(16);
                doc.text(filename.replace(/_/g, ' ').toUpperCase(), 14, 20);

                // Add timestamp
                doc.setFontSize(10);
                doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 30);

                // Create table
                doc.autoTable({
                    head: [columns],
                    body: rows,
                    startY: 40,
                    styles: {
                        fontSize: 8,
                        cellPadding: 2
                    },
                    headStyles: {
                        fillColor: [41, 128, 185],
                        textColor: 255
                    },
                    alternateRowStyles: {
                        fillColor: [245, 245, 245]
                    }
                });

                doc.save(filename + '_fallback.pdf');

            } catch (error) {
                console.error('Fallback PDF generation also failed:', error);
            }
        };

        function testPDF() {
            // Test with HTML template
            window.saveAsPDFByTemplate('pdf-content-0', 'test_report', false);
        }
        
        function testFallback() {
            // Test with data
            const testData = [
                {
                    InvoiceNumber: '10001',
                    WorkDate: '12/01/2023',
                    CompanyName: 'Test Company',
                    PropertyAddress: '123 Main St',
                    Unit: 'A101',
                    ContractorName: 'John Doe',
                    WorkOrder: 'WO-001',
                    JobDescription: 'Painting',
                    AmountCost: 1234.56,
                    DaysOverdue: 15,
                    AmountPaid: 1234.56,
                    DatePaid: '12/15/2023',
                    CheckNumber: 'CHK-001',
                    SpecialNote: 'Test note',
                    TodaysDate: '12/27/2023'
                }
            ];
            
            window.setPdfData(testData);
            window.saveAsPDFFallback('pdf-content-0', 'test_fallback', true);
        }
    </script>
</body>
</html>
